# ESM 232 Assignment 3: Almond Yield & Profit

---
author: "Kelsey Warren and Taylor Cook"
date: "2025-04-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load packages

```{r laod_packages}
library(tidyverse)
library(here)
library(purrr)
```

# 1. Develop a profit model for your almond yield

-   Use your imagination to think about what would make sense
-   Make sure you include parameters
-   You could assume a baseline profit and then adjust according to the anomaly

```{r load_data}
#load almond yield data
clim <- read.table(here("data/clim.txt"), header = TRUE, sep = "", strip.white = TRUE)

# load functions to calculate almond yield, almond profit, and the wrapper function to bring them together
source(here("~/Bren MESM/ESM 232 ENV Modeling/ESM232_EnvModeling/R/almondyield.R"))
source(here("~/Bren MESM/ESM 232 ENV Modeling/ESM232_EnvModeling/R/almond_profit.R"))
source(here("~/Bren MESM/ESM 232 ENV Modeling/ESM232_EnvModeling/R/almond_wrapper.R"))

```

# 2. Apply the profit model to your almond yield model

-   There are many ways to combine the almond yield and profit functions; you can have the profit function "call"/use the almond yield function; or create a wrapper function that calls them in sequence (first the almond yield and then the profit function)

```{r wrapper}
# Wrapper function to calculate almond profit by first calculating the yield anomaly
# Note that our updated almondyield() function is designed to calcualte yield in a chosen single year at a time, rather than for the entire time period.
# This wrapper function was already loaded above, but showing the code here for the example year 2000

almond_wrapper <- function(year = 2000, clim = clim) {
  
  # Step 1: Calculate the yield anomaly using the almondyield function
  yield_anomaly <- almondyield(year = 2000, clim = clim)
  
  # Step 2: Create a dataframe to store results (year studied, yield anomaly, and profit)
  profit_df <- data.frame(year = year, "yield anomaly" = yield_anomaly, profit = NA_real_)
  
  # Step 3: Calculate the profit using the almond_profit function and fill the profit_df data frame
  profit_df$profit <- almond_profit(yield_anomaly, clim, acres = 500, baseline_profit = 4000, 
                          price_per_ton = 6000, base_water_cost = 200)
  
  # Return the profit calculated
  return(profit_df)
}


# add results to a data frame in global environment
profit_df_2000 <- almond_profit_wrapper(2000, clim)

```

# 3. Perform a simple informal sensitivity analysis of almond yield profit using at least 2 parameters

```{r sensitivity}
# NEED TO USE PMAP TO TEST PARAMETERS


# informal sensitivity analysis for year 2000
# generate sample data of uncertainty in parameter
# using 10% uncertainty in baseline_profit
nsamples = 200
deviation = 0.10
base_prof = 4000
baseline_profit <- runif(
  min = base_prof - deviation * base_prof,
  max = base_prof + deviation * base_prof, n = nsamples)
  
# using 10% uncertainty in price_per_ton
base_price = 6000
price_per_ton <- runif(
  min = base_price - deviation * base_price,
  max = base_price + deviation * base_price, n = nsamples)

# combine the uncertain parameter values into a data frame
params_u <- cbind.data.frame(baseline_profit, price_per_ton)

# extract yield anomaly for year 2000
ya_2000 <- yield_results$yield_anomaly[yield_results$year == 2000]

# run the almond_profit() model using parameter uncertainty data generated above using pmap()
# takes function name and then names of all parameters that don't change
profit_sens_results <- params_u %>% pmap(almond_profit,
  yield_anomaly = ya_2000, clim = clim, acres = 500, base_water_cost = 200)

profit_sens_results[1]
length(profit_sens_results)

# create a data frame to store the parameters and profit results
total_profit_df  <- cbind.data.frame(profit_sens_results, params_u)


```

# 4. Create 2 graphs

```         
- one that shows yield anomaly for each year, accounting for uncertainty in the parameters
- one that show how yield anomaly in general varies with your parameters
```

```{r graphs}


################ code from InformalSensitivity2.Rmd: ################


# plot - pick on of the 2 parameter as a color

p1 <- ggplot(mean_elect, aes(ethresh, mean, col = eff)) +
  geom_point(cex = 2) +
  labs(y = "Mean Annual Electricity W", x = "Threshold Radiation (kJ/m2)  \n above which energy production is more efficient")
p2 <- ggplot(mean_elect, aes(eff, mean, col = ethresh)) +
  geom_point(cex = 2) +
  labs(y = "Mean Annual Electricity W", x = "Efficiency")
ggarrange(p1, p2)

# what do we learn from this

# extract annual
tmp <- map_df(results, `[`, c("annual"))
annual_elect <- as.data.frame(tmp$annual$year)
colnames(annual_elect) <- "year"
annual_elect$elect <- tmp$annual$elect


```

# 5. Write a short paragraph (in a Quarto document) to summarize you interpretation of your model results (e.g what do 'take away' from your model and sensitivity analysis)
