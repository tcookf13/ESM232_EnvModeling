# ESM 232 Assignment 3: Almond Yield & Profit

---
author: "Kelsey Warren and Taylor Cook"
date: "2025-04-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load packages

```{r laod_packages}
library(tidyverse)
library(here)
library(purrr)
```

# 1. Develop a profit model for your almond yield

-   Use your imagination to think about what would make sense
-   Make sure you include parameters
-   You could assume a baseline profit and then adjust according to the anomaly

```{r load_data}
#load almond yield data
clim <- read.table(here("data/clim.txt"), header = TRUE, sep = "", strip.white = TRUE)

# load functions to calculate almond yield, almond profit, and the wrapper function to bring them together
source(here("~/Bren MESM/ESM 232 ENV Modeling/ESM232_EnvModeling/R/almondyield.R"))
source(here("~/Bren MESM/ESM 232 ENV Modeling/ESM232_EnvModeling/R/almond_profit.R"))
source(here("~/Bren MESM/ESM 232 ENV Modeling/ESM232_EnvModeling/R/almond_wrapper.R"))

```

# 2. Apply the profit model to your almond yield model

-   There are many ways to combine the almond yield and profit functions; you can have the profit function "call"/use the almond yield function; or create a wrapper function that calls them in sequence (first the almond yield and then the profit function)

```{r wrapper}
# Wrapper function to calculate almond profit by first calculating the yield anomaly
# Note that our updated almondyield() function is designed to calcualte yield in a chosen single year at a time, rather than for the entire time period.
# This wrapper function was already loaded above, but showing the code here for the example year 2000
all_years = c(1989:2010)
almond_wrapper(years = all_years, clim = clim) 


# add results to a data frame in global environment
profit_df_2000 <- almond_profit_wrapper(all_years, clim)

```

# 3. Perform a simple informal sensitivity analysis of almond yield profit using at least 2 parameters

```{r sensitivity}
# NEED TO USE PMAP TO TEST PARAMETERS


# informal sensitivity analysis for year 2000
# generate sample data of uncertainty in parameter
# using 10% uncertainty in baseline_profit
nsamples = 200
deviation = 0.10
base_baseline_prof = 4000
baseline_profit <- runif(
  min = base_baseline_prof - deviation * base_baseline_prof,
  max = base_baseline_prof + deviation * base_baseline_prof, n = nsamples)
  
# using 10% uncertainty in price_per_ton
base_price = 6000
price_per_ton <- runif(
  min = base_price - deviation * base_price,
  max = base_price + deviation * base_price, n = nsamples)

# combine the uncertain parameter values into a data frame
params_u <- cbind.data.frame(baseline_profit, price_per_ton)

# extract yield anomaly for year 2000
ya_2000 <- yield_results$yield_anomaly[yield_results$year == 2000]

# run the almond_profit() model using parameter uncertainty data generated above using pmap()
# takes function name and then names of all parameters that don't change
profit_sens_results <- params_u %>% pmap(almond_profit,
  yield_anomaly = ya_2000, clim = clim, acres = 500, base_water_cost = 200)

profit_sens_results[1]
length(profit_sens_results)

# create a data frame to store the parameters and profit results
# but first unlist the profit results so they become a proper numeric vector
total_profit_df <- cbind.data.frame(
  total_profit = unlist(profit_sens_results),
  params_u
)

```

# 4. Create 2 graphs

```         
- one that shows yield anomaly for each year, accounting for uncertainty in the parameters
- one that show how yield anomaly in general varies with your parameters
```

```{r graphs}


# Plot that show how yield anomaly in general varies with your parameters

# plot 1: with price_per_ton as color

plot_1 <- ggplot(total_profit_df, aes(baseline_profit, total_profit, col = price_per_ton)) +
  geom_point(cex = 2) +
  labs(y = "Total Profit ($)", x = "Baseline Profit ($)") +
    scale_color_gradient(low = "purple", high = "yellow") 
plot_1

# plot 2: with baseline_profit as color
plot_2 <- ggplot(total_profit_df, aes(price_per_ton, total_profit, col = baseline_profit)) +
  geom_point(cex = 2) +
  labs(y = "Total Profit ($)", x = "Price per Ton ($/ton)") +
    scale_color_gradient(low = "purple", high = "yellow") 
plot_2

# view plots side by side
ggarrange(plot_1, plot_2)


# Plot that shows yield anomaly for each year, accounting for uncertainty in the parameters


```

# 5. Write a short paragraph (in a Quarto document) to summarize you interpretation of your model results (e.g what do 'take away' from your model and sensitivity analysis)
