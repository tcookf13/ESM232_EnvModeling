# ESM 232 Assignment 3: Almond Yield & Profit

---
author: "Kelsey Warren and Taylor Cook"
date: "2025-04-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load packages

```{r laod_packages}
library(tidyverse)
library(here)
library(purrr)
library(ggpubr)
```

# 1. Develop a profit model for your almond yield

-   Use your imagination to think about what would make sense
-   Make sure you include parameters
-   You could assume a baseline profit and then adjust according to the anomaly

```{r load_data}
#load almond yield data
clim <- read.table(here("data/clim.txt"), header = TRUE, sep = "", strip.white = TRUE)

# load functions to calculate almond yield, almond profit, and the wrapper function to bring them together
source(here("~/Bren MESM/ESM 232 ENV Modeling/ESM232_EnvModeling/R/almondyield.R"))
source(here("~/Bren MESM/ESM 232 ENV Modeling/ESM232_EnvModeling/R/almond_profit.R"))
source(here("~/Bren MESM/ESM 232 ENV Modeling/ESM232_EnvModeling/R/almond_wrapper.R"))

```

# 2. Apply the profit model to your almond yield model

-   There are many ways to combine the almond yield and profit functions; you can have the profit function "call"/use the almond yield function; or create a wrapper function that calls them in sequence (first the almond yield and then the profit function)

```{r wrapper}
# Wrapper function to calculate almond profit by first calculating the yield anomaly
# Note that our updated almondyield() function is designed to calcualte yield in a chosen single year at a time, rather than for the entire time period.
# This wrapper function was already loaded above, but showing the code here for the example year 2000
all_years = c(1989:2010)
almond_wrapper(years = all_years, clim = clim) 


# add results to a data frame in global environment

profit_df <- almond_wrapper(all_years, clim)

```


# 3. Perform a simple informal sensitivity analysis of almond yield profit using at least 2 parameters

```{r sensitivity}
# NEED TO USE PMAP TO TEST PARAMETERS


# informal sensitivity analysis for all years
# generate sample data of uncertainty in parameter


nsamples = 200
deviation = 0.10

# using 10% uncertainty in price_per_ton
base_price = 6000
price_per_ton <- runif(
  min = base_price - deviation * base_price,
  max = base_price + deviation * base_price, n = nsamples)


# using 10% uncertainty in acres
base_acres <- 500
acres <- runif(nsamples, 
               min = base_acres - deviation * base_acres, 
               max = base_acres + deviation * base_acres)

# combine the uncertain parameter values into a data frame
params_u <- cbind.data.frame(price_per_ton, acres)


# extract yield anomaly for all years
ya <- profit_df$yield_anomaly[profit_df$year == all_years]

# run the almond_profit() model using parameter uncertainty data generated above using pmap()
# takes function name and then names of all parameters that don't change
profit_sens_results <- params_u %>% 
  pmap(almond_profit,
    yield_anomaly = ya, 
    clim = clim,
    baseline_profit = 4000,
    base_water_cost = 200)

#profit_sens_results[1]
#length(profit_sens_results)

# create a data frame to store the parameters and profit results
# but first unlist the profit results so they become a proper numeric vector
total_profit_df <- cbind.data.frame(
  profit_sensitivity = unlist(profit_sens_results),
  params_u
)

```


# 4. Create 2 graphs

```         
- one that shows yield anomaly for each year, accounting for uncertainty in the parameters
- one that show how yield anomaly in general varies with your parameters
```

```{r graphs}

# Add year information to total_profit_df
total_profit_df$year <- rep(all_years, each = nsamples)

# Merge the two data frames by the year column
merged_df <- merge(profit_df, total_profit_df, by = "year")

# Convert the 'year' column to numeric
merged_df$year <- as.numeric(as.character(merged_df$year))




# Plot 1: Almond yield Anomaly Over Time with uncertainty in price per ton
plot_1 <- ggplot(merged_df, aes(x = factor(year), y = yield_anomaly, col = price_per_ton, group = year)) +
  geom_point() +
  labs(y = "Yield Anomaly (ton/acre)", x = "Year") +
  scale_color_gradient(low = "blue", high = "red", name = "Price Per Ton ($)") +
  theme_minimal()
plot_1



# Plot 2: Almond profits over time with uncertainty in price per ton
plot_2 <- ggplot(merged_df, aes(x = factor(year), y = profit_sensitivity)) +
  geom_point(color = "steelblue", alpha = 0.6) +  # scatter plot points
  labs(y = "Total Profit ($)", x = "Year", title = "Total Profit Over Time with Uncertainty in Price Per Ton") +
  theme_minimal()
plot_2


```

# 5. Write a short paragraph (in a Quarto document) to summarize you interpretation of your model results (e.g what do 'take away' from your model and sensitivity analysis)

The almond yield and profit model demonstrates how uncertainties in key parameters, including acres and price per ton, influence almond production and total profit over time. Plot 1, showing yield anomaly across years with uncertainty in price per ton, illustrates that small fluctuations in price can significantly affect yield, especially in years with extreme climate conditions. The color gradient is supposed to visually represent the sensitivity of yield anomalies to price changes, with higher price per ton associated with greater yield anomalies, indicating more significant profitability in years with favorable climate conditions.

Plot 2, which depicts total profit over time with uncertainty in price per ton, highlights how the variability in price impacts total profit. While fluctuations in baseline profit can play an important role, the scatter plot emphasizes how total profit is affected by the uncertainty in price per ton. The sensitivity analysis results show that while yield anomaly impacts profitability in certain years, price per ton contributes to the overall variability in total profit. These findings suggest that understanding the potential fluctuations in key parameters is critical for assessing the economic viability of almond farming under changing climate and market conditions.








